<!DOCTYPE html>
<html>
<head>
  <title> Simple JS Eval</title>
  <script src='script.js'></script>
    <script src='jquery-1.12.0.js'></script>
    <script src='/JReject/js/jquery.reject.js'></script>
    <script src='/offline-master/js/offline.js'></script>
    <script src='/offline-master/js/reconnect.js'></script>
    <script src='/offline-master/js/requests.js'></script>
    <script src='/offline-master/js/simulate.js'></script>
    <script src='/offline-master/js/snake.js'></script>
    <script src='/offline-master/js/ui.js'></script>
    <script src='Ply.js' type='text/javascript'></script>
    <script src='moment.js' type='text/javascript'></script>
    <link rel="stylesheet" type="text/css" href="ply.css">
    <link rel="stylesheet" type="text/css" href="feedReader.css">
    <link rel="stylesheet" type="text/css" href="/JReject/css/jquery.reject.css">
    <link rel='stylesheet' type="text/css" href="/offline-master/themes/offline-theme-default-indicator.css">
    <link rel='stylesheet' type="text/css" href="/offline-master/themes/offline-language-english-indicator.css">
    
    
    <script type="text/javascript">
	   $(document).ready(function(){
            reject();
	   });
    </script>
    <script>
        Offline.options = {
            checkOnLoad: true,
            interceptRequests: true,
            reconnect: {
                initialDelay: 3,
                //delay: (1.5 * last delay, capped at 1 hour)
            },
            requests: true,
            game: false
        }
        var run = function(){
            if (Offline.state === 'up')
            Offline.check();
            console.log("check");
        }
            setInterval(run, 5000);
    </script>
  <script>
      
var showLoginModal = function() {
    Ply.factory('login', function (options, data, resolve) {
        options.flags = {
            closeBtn: false,
            closeByEsc: true,
            closeByOverlay: true,
            visibleOverlayInStack: true
        };
        options.onaction = function (ui) {
            var data = ui.data;
            console.log(ui.data);
        };
    // Use base factory
        Ply.factory.use('base', options, {
        title: 'Login',
        form: {
            user: 'User ID',
            password: { hint: 'Password', type: 'password' }
        },
        ok: 'Enter',
        cancel: false
        }, resolve);
  });
    
    Ply.dialog('login').done(function (ui) {
        Ply.dialog('alert', 'Bingo!');
    });
}

var showRegisterModal = function() {
    Ply.factory('login', function (options, data, resolve) {
        options.flags = {
            closeBtn: false,
            closeByEsc: false,
            closeByOverlay: false,
            visibleOverlayInStack: true
        };

        options.onaction = function (ui) {
            var data = ui.data; 
        };

  // Use base factory
        Ply.factory.use('base', options, {
            title: 'Register',
            form: {
                email: 'E-mail',
                password: { hint: 'Password', type: 'password' }
            },
            ok: 'Enter',
            cancel: false
        }, resolve);
    });


// app.js
    Ply.dialog('login').done(function (ui) {
            Ply.dialog('alert', 'Bingo!');
            loadMySubs();
    });
}
      
var theUser = "user";
var allSubs = null;
var postObjList = null;
var debug = null;
var subIndex = null;

var aSubSelected = function(index){
  var list = document.getElementById("myFeedList").getElementsByClassName("listItem");
  for(var i = 0; i < list.length; i++){
    if(i == index){
      list[i].style.color = "red";
      list[i].style.backgroundColor = "#F2EDDA";
        subIndex = i;
    }
    else{
      list[i].style.color = "";
      list[i].style.backgroundColor = "";
    }
  }
  var link = allSubs[index].link;
  var url = "./getAllPosts?link=" + link;
  loadURL(url, function(data){
    var title = JSON.parse(data).feed.title.label;
    postObjList = JSON.parse(data).feed.entry;
    var markUp = "<h2>" + title + "</h2>";
    for (var i = 0; i < postObjList.length; i++){
        var aPost = postObjList[i];
        markUp += "<a href='javascript:aPostSelected(" + i + ")' class='listItem'>" + aPost.title.label +" </a>";
    }
    document.getElementById("currFeedWrapper").innerHTML = markUp;
  });
}

var aPostSelected = function(index) {
    var list = document.getElementById("currFeedWrapper").getElementsByClassName("listItem");
    for(var i = 0; i < list.length; i++){
        if(i == index){
            list[i].style.color = "red";
            list[i].style.backgroundColor = "#F2EDDA";
        }
        else{
            list[i].style.color = "";
            list[i].style.backgroundColor = "";
        }
    }
    var postObj = postObjList[index];
    var markUp = "";
    markUp += "<h2>" + postObj.title.label + "</h2>";
    markUp += "<h2>" + postObj["im:artist"].label + "</h2>";
    markUp += "<img src=" + postObj["im:image"][2].label + " style='height:200px;'>";
    markUp += "<h3>" + postObj["im:price"].label + "</h3>";
    
    document.getElementById("selFeedWrapper").innerHTML = markUp;
    //document.getElementById("feedDetails").innerHTML = markUp;
}
      

var startUp = function(){
    //showLoginModal();
    loadMySubs();
}

var addFeed = function() {
  var link = prompt("Add New Feed URL (json)");
  if(link == null) return;
  var url = "./addOrEditSub?user=" + theUser;
  url += "&link=" + encodeURIComponent(link);
  url += "&date=" + moment().format();
  url += "&id=" + theUser + moment().format("MMM Do YY, h:mm:ss");
  loadURL(url, function(data){
    loadMySubs();
  });
}

var loadMySubs = function() {
    
    var url = "./listSubs?user=" + theUser;
    loadURL(url, function(data){
        var mySubs = JSON.parse(data);
        allSubs = mySubs;
        if(mySubs.length == 0){
            document.getElementById("myFeedList").innerHTML = "No subsciptions" 
        }
        else {
            var markUp = "";
            for (var i = 0; i < mySubs.length; i++){
                var aFeed = mySubs[i];
                markUp += "<a href='javascript:aSubSelected(" + i + ")' class='listItem'>" + aFeed.id + " : " + aFeed.link + " </a>";
            }
        document.getElementById("myFeedList").innerHTML = markUp;
        }
        });
}

var deleteSub = function(index) {
    var answer = confirm("Are you sure you want to delete this subscription?");
    if (answer == true) {
        var list = document.getElementById("myFeedList").getElementsByClassName("listItem");
        var url = "./deleteSub?user=" + theUser + "&id=" + allSubs[subIndex].id;
        console.log(url);
        console.log(subIndex);
        console.log(list);
        console.log(list[subIndex].id);
        console.log(allSubs[subIndex]);
        loadURL(url, function(data) {
            loadMySubs();
        });
        location.reload(false);
    }
    else {
        
    }
}


  </script>
</head>

<body onload='startUp()' onload='reject()' onload='run()'> 
    <div id='pageTitle'>
        <h1> Feed Reader!</h1>
    </div>
  <div id='myFeedWrapper'>
    <h2> My Feeds </h2>
    <a href='javascript:addFeed()' style='text-decoration: none;padding: 5px; background: white; color: black; border-radius: 5px; border 1px solid black;margin:10px; box-shadow: 0px 0px 2px;'> Add New </a> <br><br>
      <a href='javascript:deleteSub(subIndex)' style='text-decoration: none;padding: 5px; background: white; color: black; border-radius: 5px; border 1px solid black;margin:10px; box-shadow: 0px 0px 2px;'> Delete Subscription </a>
    <div id='myFeedList'> </div>
  </div>
  <div id='currFeedWrapper'>
    <h2> </h2>
    <div id='currFeedList'> </div>
 </div>
  <div id='selFeedWrapper'> 
    <h2> </h2>
    <div id='feedDetails'> </div>
  </div>
</body>
    <script> 
    var reject = function(){
        $(function() { $.reject(); });
    }
    </script>
</html>
